map $arg_target $health_backend {
    "brendanmanley.com"        "https://brendanmanley.com";
    "status.brendanmanley.com" "https://status.brendanmanley.com";
    "app.brendanmanley.com"    "https://app.brendanmanley.com";
    "grafana.brendanmanley.com" "https://grafana.brendanmanley.com";
    default                    "";
}

server {
    listen 80;
    resolver 1.1.1.1 8.8.8.8 valid=30s;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }

    location ~* \.json$ {
        root /usr/share/nginx/html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    location = /health-check {
        if ($health_backend = "") {
            return 403;
        }

        proxy_pass $health_backend/;
        proxy_ssl_server_name on;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }
}
