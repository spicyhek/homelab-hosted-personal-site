map $arg_target $health_backend {
    "brendanmanley.com"         "https://brendanmanley.com";
    "app.brendanmanley.com"     "https://app.brendanmanley.com";
    "grafana.brendanmanley.com" "http://grafana:3000";
    "status.brendanmanley.com"  "http://uptime-kuma:3001";
    default                     "";
}

server {
    listen 80;
    resolver 127.0.0.11 1.1.1.1 8.8.8.8 valid=30s;

    location / {
        root /usr/share/nginx/html;
        index index.html;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }

    location = /health-check {
        if ($health_backend = "") {
            return 403;
        }

        proxy_pass $health_backend/;
        proxy_ssl_server_name on;
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
        proxy_intercept_errors on;
        error_page 301 302 303 307 308 =200 @health_up;
        error_page 502 504 =503 @health_down;
    }

    location @health_up {
        return 200;
    }

    location @health_down {
        return 503;
    }
}
